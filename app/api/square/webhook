import { buffer } from 'micro';
import crypto from 'crypto';

export const config = { api: { bodyParser: false } };

export default async function handler(req, res) {
  const bodyBuffer = await buffer(req);
  const signature = req.headers['x-square-signature'];

  const hash = crypto
    .createHmac('sha1', process.env.SQUARE_WEBHOOK_SIGNATURE_KEY)
    .update(bodyBuffer)
    .digest('base64');

  if (hash !== signature) {
    return res.status(401).send('Invalid signature');
  }

  // Traiter le webhook Sandbox ici (ex: log pour test)
  console.log('Webhook re√ßu:', req.body);

  res.status(200).send('OK');
}
